local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- [[ SETUP DO TEMA CUSTOM ]] --
local ThemeTable = loadstring(game:HttpGet("https://raw.githubusercontent.com/Griiem/Lunar/refs/heads/main/Lunar%20Theme"))()
Rayfield.Theme.LunarPro = ThemeTable

-- [[ LIMPEZA DE AMBIENTE ]] --
if getgenv().VFX_JumpConn then getgenv().VFX_JumpConn:Disconnect() end
if getgenv().VFX_CharConn then getgenv().VFX_CharConn:Disconnect() end
if getgenv().VFX_Cleaner then getgenv().VFX_Cleaner:Disconnect() end

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")
local player = Players.LocalPlayer

getgenv().SelectedVFX = "None"
getgenv().GlobalVolume = 0.5

-- [[ CONFIGURAÇÕES GLOBAIS ]] --
-- Pos = 0.05 é o segredo: ele fica 0.05 studs acima do chão pra não bugar a textura kkk
local EffectsConfig = {
    ["None"]          = {Delay = 0, Pos = 0, Life = 0},
    ["Atomic"]        = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Default"]       = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Earth"]         = {Delay = 0.13, Pos = 0.05, Life = 1.0},
    ["Fire"]          = {Delay = 0.13, Pos = 0.05, Life = 1.0},
    ["HighFlyer"]     = {Delay = 0.13, Pos = 0.05, Life = 1.0},
    ["Ice"]           = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Light"]         = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Lightning"]     = {Delay = 0.13, Pos = 0.05, Life = 1.0},
    ["NewYears"]      = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Nuclear"]       = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Purple"]        = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["SUMMER2025"]    = {Delay = 0.13, Pos = 0.05, Life = 1.0},
    ["Santa"]         = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["ServerBooster"] = {Delay = 0.13, Pos = 0.05, Life = 0.8},
    ["Water"]         = {Delay = 0.13, Pos = 0.05, Life = 1.0},
    ["XMAS2025"]      = {Delay = 0.13, Pos = 0.05, Life = 1.0},
}

-- [[ LÓGICA DE SPAWN ]] --
local function spawnVFX(surfaceCF)
    if getgenv().SelectedVFX == "None" then return end
    local config = EffectsConfig[getgenv().SelectedVFX]
    local original = ReplicatedStorage:WaitForChild("Effects"):WaitForChild("Jump"):FindFirstChild(getgenv().SelectedVFX)
    
    if original then
        local clone = original:Clone()
        clone:SetAttribute("IsGeminiEffect", true)
        for _, obj in pairs(clone:GetDescendants()) do if obj:IsA("LuaSourceContainer") then obj:Destroy() end end
        
        -- AJUSTE DE COLISÃO VISUAL --
        -- O efeito agora usa a superfície do chão como base e sobe o mínimo necessário (Pos)
        local spawnPosition = surfaceCF * CFrame.new(0, config.Pos, 0)
        
        if clone:IsA("Model") then
            clone:PivotTo(spawnPosition)
        else
            clone.CFrame = spawnPosition
        end
        
        clone.Anchored = true
        clone.CanCollide = false -- VFX não deve ter colisão física pra não te empurrar kkk
        clone.Parent = Workspace
        
        local sound = clone:FindFirstChild("SoundEffect")
        if sound and sound:IsA("Sound") then
            sound.Volume = getgenv().GlobalVolume
            sound:Play()
        end
        
        for _, p in pairs(clone:GetDescendants()) do
            if p:IsA("ParticleEmitter") then p:Emit(p.Rate + 20) p.Enabled = true end
        end
        Debris:AddItem(clone, config.Life)
    end
end

-- [[ JANELA PRINCIPAL ]] --
local Window = Rayfield:CreateWindow({
    Name = "Lunar Hub // PRO",
    LoadingTitle = "Carregando...",
    LoadingSubtitle = "Premium",
    ConfigurationSaving = { Enabled = true, FolderName = "LunarHubData", FileName = "Config" },
    Theme = "LunarPro", 
    Discord = { Enabled = false, Invite = "noinvitelink", RememberJoins = true },
    KeySystem = false, 
})

local JumpTab = Window:CreateTab("JumpChanger", 4483362458)

-- [[ UI ELEMENTS ]] --
local options = {}
for name in pairs(EffectsConfig) do table.insert(options, name) end
table.sort(options)

JumpTab:CreateDropdown({
    Name = "Efeito de Pulo",
    Options = options,
    CurrentOption = "None",
    Callback = function(v) getgenv().SelectedVFX = (type(v) == "table" and v[1] or v) end
})

JumpTab:CreateSlider({
    Name = "Volume SFX",
    Range = {0, 10},
    Increment = 0.5,
    CurrentValue = 0.5,
    Callback = function(v) getgenv().GlobalVolume = v end
})

-- [[ DETECÇÃO DE PULO ]] --
local function connect(char)
    local hum = char:WaitForChild("Humanoid")
    local root = char:WaitForChild("HumanoidRootPart")
    
    getgenv().VFX_JumpConn = hum.StateChanged:Connect(function(_, newState)
        if newState == Enum.HumanoidStateType.Jumping and getgenv().SelectedVFX ~= "None" then
            -- RAYCAST PRECISO: Ignora players e foca no chão do mapa
            local params = RaycastParams.new()
            params.FilterDescendantsInstances = {char, Workspace:FindFirstChild("Players")}
            params.FilterType = Enum.RaycastFilterType.Exclude

            local res = Workspace:Raycast(root.Position, Vector3.new(0, -20, 0), params)
            
            if res then
                -- O segredo: Usa a rotação do player + a posição exata de impacto do raio
                local rotation = root.CFrame - root.CFrame.Position
                local surfaceCF = CFrame.new(res.Position) * rotation
                
                task.wait(EffectsConfig[getgenv().SelectedVFX].Delay)
                spawnVFX(surfaceCF)
            end
        end
    end)
end

-- Iniciar
if player.Character then connect(player.Character) end
